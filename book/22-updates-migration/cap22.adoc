== Update und Migration

Erinnern Sie sich an die Ausführungen zur _Releasestrategie_ aus Kapitel
2.4? Dort haben wir gelernt, dass das Joomla!-Projekt in überschaubaren
Zeitabständen eine neue CMS-Version veröffentlicht, sodass sich
automatisch die Frage stellt, wie ein _Update_ bzw. eine _Migration_
zwischen den unterschiedlichen Joomla!-Versionen erfolgt.

Betrachten wir dafür zuerst die zwei verschiedenen Aktualisierungstypen:

* _Update:_ Aktualisierung einer bestehenden Joomla!-Installation
innerhalb eines Versionszweigs (3.6 ++>++ 3.7) oder einer Version (3.7.0
++>++ 3.7.1) über die in Joomla! integrierte
Aktualisierungserweiterungen, die wir über den Menüeintrag Komponente
++>++ Joomla-Aktualisierung erreichen können.
* _Migration:_ Übertragen einer bestehenden Joomla!-Seite von einem
Versionszweig in einen anderen (z. B. 2.5 ++>++ 3.7 oder 3.7 ++>++ 4.0).
Diese größeren Versionssprünge benötigen einige Vorarbeiten

Ich möchte mich in diesem Kapitel auf die grundsätzliche Beschreibung
des Migrationsvorgangs konzentrieren, da der normale Update-Vorgang (Typ
1, siehe oben) im Regelfall problemlos und schmerzfrei vonstattengeht
und abgesehen von einem vorherigen Backup für den Fall der Fälle keine
weiteren Vorbereitungen erfordert.

=== Migrationen: theoretischer Ablauf

Das Grundprinzip bei den Migrionen ist schnell erklärt: dank des
Update-Mechanismus, der seit Joomla! 2.5 im Core integriert ist, führt
die Kerninstallation alle benötigten Anpassungen für die Migrationen
selbstständig aus:

* Herunterladen des Update-Pakets auf den Server
* Entpacken des Pakets in ein temporäres Verzeichnis
* Überschreiben der Dateien durch die neue Version
* Entfernen nicht mehr benötigter Dateien vom Dateisystem
* Anpassung der Datenbankstruktur an die neue Version
+
Aus dem Kapitel 2.4 wissen wir bereits, das eine solche Migration mit
Änderungen einher geht, die nicht _Rückwärtskompatibel_ sind – für den
Joomla-Kern an sich ist das jedoch kein Problem, da dieser ja durch den
Updater an den neuen Code angepasst wird und es somit keine Probleme bei
der Rückwärtskompatibilität geben kann. Aus dieser Überlegung ergibt
sich aber auch sofort unser Problemfeld: Haben wir in unserer zur
migrierenden Joomla-Installation Erweiterungen von Drittherstellern im
Einsatz, werden diese bei der Migration des Kerns unverändert in die
neue Version übernommen, sind dort dann aber aufgrund der inkompatiblen
Änderungen oftmals nicht mehr lauffähig und verhinden somit den
Seitenaufruf. _Dritterweiterungen_ müssen somit entweder vor der
Migration entfernt werden oder auf einen Versionsstand gebracht werden,
der den Betrieb in der alten und neuen Version erlaubt.
+
Nachdem diese theoretischen Überlegungen verinnerlicht sind, gilt es
nun, diese in die Praxis umzusetzen.

=== Schritt 1: Kopie erstellen

Für unser Praxisbeispiel verwenden wir eine relativ simple Joomla 2.5
Installation, die auf 3.x migriert werden soll. Im ersten Schritt
erstellen wir hierfür eine Kopie unserer veralteten Installation, um
eine abgeschirmte Arbeitsumgebung zu haben und den Betrieb der Seite
nicht zu unterbrechen. Mein persönliches Tool der Wahl dafür ist
_AkeebaBackup_ und das Verfahren zur Erstellung einer Kopie bereits in
Kapitel 19.3, Transfer mit AkeebaBackup beschrieben.

[width="99%",cols="14%,86%",options="header",]
|===
|CHV++_++BOX++_++ID++_++01 |
|icn001 |Der eigentliche Migrationsvorgang ist technisch gesehen ein
relativ aufwendiger Vorgang und benötigt bei umfangreichen
Installationen (und insbesondere bei großen Datenbanken) durchaus einige
Minuten und verbraucht dabei viel Arbeitsspeicher. Es empfiehlt sich
daher, die Migration auf einem Webspace vorzunehmen, auf dem man die
PHP-Optionen memory++_++limit und max++_++execution++_++time auf sehr
hohe Werte (memory++_++limit mindestens 256MB,
max++_++execution++_++time auf 600 Sekunden) setzen kann, die im
Normalbetrieb niemals notwendig wären. Wird das Update nämlich durch
eine dieser Ressourcenbegrenzungen zwischendrin unterbrochen, bleibt in
der Regel eine kaputte Installation zurück.
|===

=== Schritt 2: Erweiterungen prüfen

Im nächsten Schritt prüfen wir die installierten _Dritterweiterungen_
auf Kompatibilität mit unserer Zielversion. Dabei ist zu beachten, dass
alle Erweiterungstypen, also _Komponenten_, _Module_, _Plugins_,
_Bibliotheken_ und _Templates_ geprüft werden müssen, da in jedem
Erweiterungstyp Inkompatibilitäten auftreten könnten.

Um die installierten Erweiterungen prüfen zu können, müssen wir uns im
ersten Schritt mal einen Überblick über selbige verschaffen.
Praktischerweise hat Joomla! eine Liste der installierten Erweiterungen,
die Typ-übergreifend funktioniert und uns an einer Stelle einen
Gesamtüberblick gibt. Sie finden diese Liste unter Erweiterungen ++>++
Verwalten ++>++ Verwalten in der Administration.

In der Liste sind sowohl die installierten Dritterweiterungen
aufgeführt, als auch die _Erweiterungen_, die Joomla! von Haus aus
mitbringt, und die somit automatisch kompatibel zur neuen Version sind.
Um hier schneller erkennen zu können, welche Erweiterungen zur Joomla!
selbst und welche zu Drittanbietern gehören, sollte die entsprechende
Liste absteigend nach der _ID_ der jeweiligen Erweiterung sortiert
werden, da nachinstallierte Dritterweiterungen naturgemäß höhere IDs
bekommen, als vorinstallierte _Core-Erweiterungen_ (Siehe Bild 22.1).

image:book/22-updates-migration/media/1.png[book/22-updates-migration/media/1,width=548,height=328]

Bild 22.1 Erweiterungsliste einer Joomla! 2.5 Installation, absteigend
sortiert nach ID

[width="99%",cols="14%,86%",options="header",]
|===
|CHV++_++BOX++_++ID++_++02 |
|icn002 |In einigen Anleitungen zum Thema Migration findet sich der
Hinweis, dass Dritterweiterungen IDs haben, die größer als 10000 sind,
was diese natürlich nochmals erheblich leichter erkennbar machen würde.
Leider gibt es aber verschiedene Situationen, in denen diese Faustregel
nicht zutrifft, daher sollten Sie immer die gesamte Liste prüfen.
|===

Nun gilt es die Einträge in dieser Liste Erweiterung für Erweiterung zu
prüfen, wobei sich das folgende Vorgehen anbietet:

[arabic]
. handelt es sich bei der jeweiligen Erweiterung um eine
Core-Erweiterung? Falls ja, können wir den Eintrag ignorieren, da
Core-Erweiterungen ja standardmäßig kompatibel sind. Indikatoren für
eine Core-Erweiterungen können sein:
. Als _Autor_ wird das Joomla-Projekt genannt
. Die Erweiterung ist eine sog. geschützte Erweiterung, symbolisiert
durch ein Schloss in der Status-Spalte
. Die Erweiterung hat eine kleinere ID als die installierten
Dritterweiterungen
. Die Erweiterung ist auch in einer frischen Vergleichsinstallation
enthalten
. Gibt es auf der Website des Herstellers eine Information zur
Kompatibilität der jeweiligen Erweiterung mit der geplanten, neuen
Joomla-Version? Falls ja, ab welcher Version ist diese gegeben? Gibt es
eine entsprechende Version, wird diese installiert und zum nächsten
Eintrag gesprungen.
. Gibt es auf der Website des Herstellers eine Anleitung, wie ein
Upgrade auf die neue Version manuell erfolgen kann? Falls ja folgen wir
dieser Anleitung.
. Wenn es weder eine Migrationsanleitung noch eine kompatible Version
gibt, bleibt uns nichts anderes übrig als die entsprechende Erweiterung
zu deinstallieren, was wir über die entsprechende Checkbox und das
Werkzeug Deinstallieren in der Toolbar vornehmen können
+
Wir erarbeiten uns somit Stück für Stück eine Joomla-Installation, bei
der alle installierten Erweiterungen sowohl mit der aktuellen als auch
mit der neuen Version kompatibel sind.

==== Sonderfall Templates

Drei Besonderheiten gibt es bei Templates zu berücksichtigen:

[arabic]
. verfügen sehr viele Templates über _Overrides_ (siehe Kapitel 12), die
im Regelfall eng an eine spezielle Joomla-Version gebunden sind. Diese
Overrides müssen also bei einer Migration stets an die neue Version
angepasst bzw. durch neue Overrides auf Basis des neuen Codes ersetzt
werden
. wird das Design des jeweiligen Templates durch HTML und das zugehörige
CSS bestimmt. Wenn sich in neuen Joomla-Versionen das ausgegebene HTML
verändert, passt der CSS-Code nicht mehr dazu und es kommt zu
Stylingfehlern
. laden die unterschiedlichen Joomla-Versionen unterschiedliche CSS- und
JS-_Frameworks_ nach. Ist z.B. ein Joomla! 2.5 Template noch auf Basis
des veralteten aber in 2.5 integrierten JavaScript-Frameworks MooTools
erstellt worden, wird dieses ohne Anpassung nicht unter 3.x lauffähig
sein, da hier MooTools nicht mehr standardmäßig geladen wird
+
In vielen Fällen wird eine Migration auf die neue Joomla-Version daher
auch mit einem Template-Wechsel verbunden sein, denn die wenigsten
Template-Entwickler aktualisieren ihre Werke für neue Versionen.

=== Schritt 3: Backup!

Wir haben bis hierhin nun schon einiges an Arbeit investiert – würde
beim nächsten Schritt, der eigentlichen Migration, etwas schief laufen,
wäre diese geleistete Arbeit verloren und wir müssten von Vorne anfangen
– daher empfiehlt es sich ein weiteres _Backup_ zu erstellen.

=== Schritt 4: Migration

Nun kommt der spannende Part: wir führen die eigentlich Migration auf
die neue Version durch. Dafür wechseln wir in die
Joomla-Aktualisierungs-Komponente per Klick auf Komponenten ++>++
Joomla-Aktualisierung. Da die Aktualisierungs-Komponente standardmäßig
auf Updates innerhalb eines Versionszweigs ausgerichtet ist, müssen wir
den verwendeten _Aktualisierungsserver_ verändern. Den entsprechenden
Parameter finden wir nach einem Klick auf den Button Optionen in der
Werkzeugleiste der Erweiterung. Der korrekte Server für ein Update auf
3.x ist _Kurzzeit-Support_, siehe Bild 22.2.

image:book/22-updates-migration/media/2.png[book/22-updates-migration/media/2,width=548,height=304]

Bild 22.2 Auswahl des Aktualisierungsservers in Joomla! 2.5

Nachdem wir den neuen Server durch einen Klick auf Speichern&Schließen
bestätigt haben, wird uns das Update auf 3.x angeboten, siehe Bild 22.3.

image:book/22-updates-migration/media/3.png[book/22-updates-migration/media/3,width=548,height=236]

Bild 22.3 Aktualisierung einer 2.5 Installation auf 3.x

Dem aufmerksamen Beobachter wird dabei auffallen, dass die angegebene
3.x Version nicht die aktuelle Version ist, sondern die Version _3.5.1_
angeboten wird. Was im ersten Moment wie ein Fehler wirkt, durch eine
interne Anpassung der _Aktualisierungskomponente_ bedingt, die mit
Joomla _3.5.2_ eingeführt wurde. Diese Anpassung hat dazu geführt, dass
2.5.x Installationen nicht mehr direkt auf _3.5.2_ aktualisiert werden
konnte, womit ein zweistufiger Prozess (_2.5.x_ ++>++ _3.5.1_ und dann
_3.5.1_ auf die aktuelle Version) notwendig wurde. Die Aktualisierung
startet per Klick auf AKtualisierung installieren.

In den folgenden Schritten erfolgt dann die Aktualisierung der
Core-Installation, die, wenn alles glatt läuft, mit einer entsprechenden
Erfolgsmeldung endet. Anschließend kann die aktualisierte Installation
geprüft und angepasst werden, um sicherzustellen, dass sie unter 3.x
ordnungsgemäß funktioniert.

[width="99%",cols="14%,86%",options="header",]
|===
|CHV++_++BOX++_++ID++_++01 |
|icn001 |Nach dem Update auf eine neue Version müssen die JavaScript-
und CSS-Dateien der neuen Version verwendet werden, damit die Seite
ordnungsgemäß funktioniert. Da Browser diese Dateien aber standardmäßig
zwischenspeichern, sollte nach dem Update der Browsercache geleert
werden.
|===

[width="99%",cols="14%,86%",options="header",]
|===
|CHV++_++BOX++_++ID++_++01 |
|icn001 |In bestimmten Situationen kann es vorkommen, dass
Core-Erweiterungen einer neuen Joomla-Version nicht korrekt installiert
bzw. Datenbankanpassungen nicht komplett eingespielt werden. Um dies zu
prüfen, empfiehlt es sich nach dem Update in den beiden Bereichen
Erweiterungen ++>++ Verwalten ++>++ Überprüfen und Erweiterungen ++>++
VerWalten ++>++ Datenbank nach entsprechenden Problemen zu sehen.
|===

=== Schritt 5: Übertragen der Seite

Im letzten Schritt übertragen wir die aktualisierte Seite zurück auf den
Live-Server und prüfen auch dort nochmals die ordnungsgemäße Funktion.

[width="99%",cols="14%,86%",options="header",]
|===
|CHV++_++BOX++_++ID++_++01 |
|icn001 |Neuere Joomla-Versionen sind in der Regel mit aktuelleren
PHP-Versionen kompatibel, als es Vorgängerversionen sind. Daher
empfiehlt es sich, nach dem erfolgreichen Update zu prüfen, ob es nicht
beim Webhoster die Möglichkeit gibt, auf eine neuere PHP-Version zu
wechseln.
|===

[arabic, start=9]
. {blank}
. {blank}
. {blank}
. {blank}

[width="99%",cols="14%,86%",]
|===
| |
|===

[width="99%",cols="14%,86%",]
|===
| |
|===

===

* {blank}
* {blank}
* {blank}

===

=== Migration eigener Erweiterungen

Sie haben eigene Erweiterungen für Joomla! 2.5 entwickelt und wollen
diese nun auf 3.x migrieren? Wenn Sie sich an das MVC-Framework gehalten
haben, reicht es, die in der Dokumentation beschriebenen Schritte
durchzugehen, um die eigene Erweiterung an die API-Änderungen
anzupassen:
[.underline]#https://docs.joomla.org/Potential++_++backward++_++compatibility++_++issues++_++in++_++Joomla++_++3++_++and++_++Joomla++_++Platform++_++12.2#
