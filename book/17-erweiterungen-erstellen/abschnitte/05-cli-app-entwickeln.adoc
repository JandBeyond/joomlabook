=== CLI-Applikationen entwickeln

Als Letztes möchte ich Ihnen noch eine relativ unbekannte, weil neue
Fähigkeit der Joomla!-API demonstrieren: die Realisierung von
Programmen, die über die Kommandozeile (_CLI = Command Line Interface_)
bedient werden können.

Dabei ist es möglich, nur die Klassen und Methoden des Frameworks zu
nutzen, um eine bestimmte, Joomla!-unabhängige Funktionalität zu
realisieren (z.B. einen RSS-Feed zu parsen und auszugeben), als auch auf
den Datenbestand einer Joomla!-Installation zuzugreifen, um
beispielsweise Aktionen durchzuführen, die per CRON-Job ausgeführt
werden müssen.

Den grundsätzlichen Aufbau einer solchen _CLI_-Applikation möchte ich
Ihnen anhand eines Beispiels zeigen, das Sie in Listing 17.40 finden.

LISTING 17.40 Beispiel-App für die CLI-Schnittstelle

++<++?php

// Initialize Joomla framework

const ++_++JEXEC = 1;

// Load system defines

if (file++_++exists(dirname(++__++DIR++__++) . '/defines.php'))

++{++

require++_++once dirname(++__++DIR++__++) . '/defines.php';

}

if (!defined('++_++JDEFINES'))

++{++

define('JPATH++_++BASE', dirname(++__++DIR++__++));

require++_++once JPATH++_++BASE . '/includes/defines.php';

}

// Get the framework.

require++_++once JPATH++_++LIBRARIES . '/import.legacy.php';

// Bootstrap the CMS libraries.

require++_++once JPATH++_++LIBRARIES . '/cms.php';

class SetPassword extends JApplicationCli

++{++

public function ++__++construct()

++{++

parent::++__++construct();

$this-++>++loadConfiguration($this-++>++fetchConfigurationData("../­configuration.php"));

}

//Set Password

public function set++_++password( $username, $password )

++{++

$db = JFactory::getDbo();

$query = $db-++>++getQuery(true);

$query-++>++select("id")-++>++from("#++__++users")-++>++where("username
= " . $db-++>++quote($username));

$db-++>++setQuery($query);

$userid = $db-++>++loadResult();

$user = JUser::getInstance($userid);

if($user-++>++id)

++{++

$password = JUserHelper::hashPassword($password);

$query = $db-++>++getQuery(true);

$query-++>++update("#++__++users")-++>++set("password =
".$db-++>++quote($password))-++>++where("id = ".$user-++>++id);

$db-++>++setQuery($query)-++>++query();

return true;

}

else

++{++

return false;

}

}

public function execute()

++{++

$this-++>++out( 'What is your username?' );

$username = $this-++>++in( );

$this-++>++out( 'Enter your new password?' );

$password = $this-++>++in( );

if($this-++>++set++_++password( $username, $password ))

++{++

$this-++>++out( "Password successfully changed" );

}

else

++{++

$this-++>++out( "Invalid Username" );

}

}

}

JCli::getInstance('SetPassword')-++>++execute();

Die vorliegende Applikation ändert das Passwort eines beliebigen
Joomla!-Benutzers und fragt die dafür notwendigen Parameter
_Benutzername_ und _Passwort_ ab.

Wir beginnen, indem wir die neue Klasse SetPassword definieren, die von
der Klasse JApplicationCLI abgeleitet wird. Diese Klasse besitzt nur
drei Methoden:

Die Konstruktor-Methode lädt die _configuration.php_ unserer
Joomla!-Installation und nutzt die Konfigurationsdaten (inklusive der
Angaben für die Datenbankverbindung) in unserer eigenen CLI-App.

Die execute-Methode fragt die benötigten Angaben ab und übergibt diese
an die Methode setPassword, die dann das Passwort des Benutzers neu
setzt.

Damit die ganze Applikation „ins Rollen“ kommt, fügen wir am Ende der
Datei den finalen Aufruf
JCli::getInstance('SetPassword')-++>++execute(); ein, der unsere
Applikation startet.

Notwendig für eine eigene CLI-Applikation sind nur die execute-Methode
sowie ein entsprechender JCli:getInstance-Aufruf am Ende der Datei – und
schon haben wir eine Applikation geschrieben, die wir über die
Kommandozeile steuern können.

Wenn wir diesen Code nun in der Datei _setpassword.php_ im Ordner _/cli_
unserer Installation speichern, können wir sie im Terminal bzw. in der
Eingabeaufforderung mittels php setpassword.php starten (siehe Bild
17.6).

image:book/17-erweiterungen-erstellen/media/9.png[C:++\++Users++\++hwunder++\++Desktop++\++rtf++\++17++\++Bild6141.PNG,width=547,height=72]

BILD 17.6 Ausgabe der CLI-App aus Listing 17.40
